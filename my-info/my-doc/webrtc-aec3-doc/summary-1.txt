https://zhuanlan.zhihu.com/p/626719118

AEC3是WebRTC中基于子带滤波器实现的的一种回声消除算法，目标是在语音通话过程中消除远端信号（扬声器输出）在近端信号（麦克风输入）中的回声，从而提高通话质量和清晰度。为了实现这一目标，AEC3需要估计远端信号与近端信号之间的延时并对齐两个信号。

AEC3中的时延估计算法是使用计算滤波器能量最大块来作为延迟估计值，它是当滤波器收敛到一定程度时，计算所有滤波器系数的能量，取峰值的系数（tap）对应的delay就是对齐需要的delay，之后使得远端信号与近端信号在时域上达到最佳对齐。为了实现这一目标，AEC3采用了匹配滤波器（Matched Filter）技术。

匹配滤波器通过计算两个信号之间的互相关函数来估计信号之间的延时。互相关函数的峰值对应的延时值即为最佳延时估计值。在AEC3中，使用了步长为0.7的5个时域的NLMS滤波器来实现匹配滤波器。

这5个滤波器分别处理不同的延时范围，每个滤波器默认为32个块，每个块有16个样点，总计有32*16=512个样点。5个滤波器理论上共有512*5=2560个点，但实际上5个滤波器在时域上互相重叠8块（即输入的信号在时间上存在重叠），所以实际上5个滤波器可以估计2560-8*16*4（重叠一共有4块区域）=2048个样点。由于输入信号是经过分频后（低频0~16kHz）再经过4倍下采样的信号（实际采样率为4000Hz），所以实际最多能估计的延迟为2048/4000=512ms。

NLMS（Normalized Least Mean Squares）算法是一种自适应滤波算法，用于估计信号的滤波器系数。它可以根据输入信号和期望输出信号之间的误差来更新滤波器系数，从而实现滤波器的自适应调整。


NLMS算法的步骤如下：

初始化滤波器系数
在NLMS算法开始运行之前，需要对滤波器系数进行初始化。通常情况下，可以将滤波器系数初始化为0或者一个较小的随机值。

输入信号和期望输出信号
在每个时间步骤，NLMS算法会接收到一个输入信号x(n)和一个期望输出信号d(n)。其中，x(n)是输入信号的样本值，d(n)是期望输出信号的样本值。

计算滤波器的输出信号
根据当前的滤波器系数，NLMS算法可以计算出滤波器的输出信号y(n)。滤波器的输出信号是输入信号x(n)和滤波器系数w(n)的加权和，即：y(n) = w(n) * x(n)

计算误差信号
将期望输出信号d(n)和滤波器的输出信号y(n)相减，可以得到误差信号e(n)。误差信号表示期望输出信号与实际输出信号之间的差异，即：e(n) = d(n) - y(n)

更新滤波器系数
NLMS算法的核心是根据误差信号e(n)来更新滤波器系数w(n)。具体地，NLMS算法会根据以下公式来更新滤波器系数：


其中，μ是步长参数，用于控制滤波器系数的更新速度；δ是一个小的正数，用于避免分母为0的情况；||x(n)||表示输入信号x(n)的能量。

归一化滤波器系数
为了避免滤波器系数过大或过小，NLMS算法会对滤波器系数进行归一化处理。具体地，NLMS算法会将滤波器系数除以滤波器系数的模长，从而得到归一化的滤波器系数。

重复迭代
NLMS算法会不断地接收输入信号和期望输出信号，并根据误差信号来更新滤波器系数。重复执行第二步至第六步，直到滤波器系数收敛或达到预设的迭代次数。

综上，NLMS算法是一种自适应滤波算法，可以根据输入信号和期望输出信号之间的误差来更新滤波器系数，从而实现滤波器的自适应调整。它可以有效地估计信号的滤波器系数，并实现自适应滤波。NLMS算法的优点是收敛速度快，对于非平稳信号和非线性系统也有较好的适应性。但是，它也存在一些缺点，如对于高动态范围信号和噪声较大的情况，容易出现数值不稳定和收敛慢的问题。